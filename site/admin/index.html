<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin Login | AustralianRates</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../frame.css">
    <link rel="stylesheet" href="admin-common.css">
    <script src="../theme.js"></script>
    <style>
        .admin-login { max-width: 420px; margin: 4rem auto; padding: 2rem; background: var(--card); border-radius: 12px; box-shadow: var(--panel-shadow); }
        .admin-login h1 { margin: 0 0 1.5rem; font-size: 1.5rem; color: var(--text); }
        .admin-login label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--muted); }
        .admin-login input[type="password"] { width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; background: var(--input-bg); color: var(--text); }
        .admin-login button { width: 100%; padding: 12px; background: var(--brand); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .admin-login button:hover { opacity: 0.9; }
        .admin-login button:disabled { opacity: 0.6; cursor: not-allowed; }
        .admin-login .error { margin-top: 1rem; padding: 10px; border-radius: 8px; font-size: 0.9rem; display: none; }
        .admin-login .error.visible { display: block; }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="site-header-inner">
            <h1 class="site-brand"><a href="/">AustralianRates</a></h1>
        </div>
    </header>
    <main class="admin-login" id="main-content" tabindex="-1">
        <h1>Admin login</h1>
        <p style="color: var(--muted); margin-bottom: 1.5rem;">Enter your admin API token to continue.</p>
        <form id="login-form" action="#" method="post">
            <label for="admin-token">API token</label>
            <input id="admin-token" name="token" type="password" placeholder="Paste ADMIN_API_TOKEN" autocomplete="off" required>
            <button type="submit" id="login-btn">Log in</button>
        </form>
        <div class="error" id="login-error" role="alert"></div>
    </main>
    <script src="admin-portal.js"></script>
    <script src="../frame.js"></script>
    <script>
        (function () {
            var form = document.getElementById('login-form');
            var btn = document.getElementById('login-btn');
            var errEl = document.getElementById('login-error');
            var apiBase = window.AR && window.AR.AdminPortal ? window.AR.AdminPortal.apiBase() : (window.location.origin + '/api/home-loan-rates');

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                var token = (document.getElementById('admin-token').value || '').trim();
                if (!token) {
                    errEl.textContent = 'Please enter a token.';
                    errEl.classList.add('visible');
                    return;
                }
                errEl.classList.remove('visible');
                errEl.textContent = '';
                btn.disabled = true;
                btn.textContent = 'Checkingâ€¦';

                fetch(apiBase + '/admin/runs?limit=1', { headers: { Authorization: 'Bearer ' + token } })
                    .then(function (r) {
                        if (r.ok) {
                            window.AR.AdminPortal.setToken(token);
                            window.location.href = 'dashboard.html';
                            return;
                        }
                        return r.json().then(function (d) {
                            var reason = (d && d.error && d.error.details && d.error.details.reason) ? d.error.details.reason : '';
                            var msg = (d && d.error && d.error.message) ? d.error.message : 'Login failed. Check your token.';
                            if (reason) msg += ' (' + reason + ').';
                            if (reason === 'admin_token_or_access_jwt_required') msg += ' On production, set ADMIN_API_TOKEN in Cloudflare: cd workers/api && wrangler secret put ADMIN_API_TOKEN';
                            if (reason === 'invalid_bearer_token') msg = 'The token does not match ADMIN_API_TOKEN on the server. Update it with: cd workers/api && wrangler secret put ADMIN_API_TOKEN';
                            if (reason === 'admin_token_not_configured') msg = 'Admin token is not configured on the server. Set ADMIN_API_TOKEN in Cloudflare: cd workers/api && wrangler secret put ADMIN_API_TOKEN';
                            errEl.textContent = msg;
                            errEl.classList.add('visible');
                        }).catch(function () {
                            errEl.textContent = 'Login failed. Check your token.';
                            errEl.classList.add('visible');
                        });
                    })
                    .catch(function (err) {
                        errEl.textContent = err && err.message ? err.message : 'Network error.';
                        errEl.classList.add('visible');
                    })
                    .finally(function () {
                        btn.disabled = false;
                        btn.textContent = 'Log in';
                    });
            });
        })();
    </script>
</body>
</html>
